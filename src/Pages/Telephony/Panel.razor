@page "/pages/telephony/panel"
@attribute [Authorize]
@using Microsoft.Extensions.Options
@using Sufficit.Client
@using Sufficit.Telephony
@using Sufficit.Blazor.Client.Models
@inherits TelephonyBasePageComponent 

<EventsPanel Cards="@MyCards"></EventsPanel>

@code{
    protected List<EventsPanelCardMonitor> MyCards { get; set; }

    [Inject]
    private APIClientService? APIClient { get; set; }

    [Inject]
    private EventsPanelService? Service { get; set; }

    [Inject]
    public IOptionsMonitor<EventsPanelCardOptions> Monitor { get; set; }

    protected void OnConfigure(EventsPanelCardOptions options)
    {
        MyCards = new List<EventsPanelCardMonitor>();
        foreach (var card in options)
        {
            MyCards.Add(new EventsPanelCardMonitor(card));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var endpoints = await APIClient.Telephony.EventsPanel.GetEndpoints();
        if(endpoints != null)
        {
            var ep = endpoints.FirstOrDefault();
            if(ep != null)
            {
                var options = new AMIHubClientOptions() { Endpoint = new Uri(ep.Endpoint) };
                var client = new AMIHubClient(options, null);
                Service.Configure(client);
            }
        }

        Monitor.OnChange(OnConfigure);
        OnConfigure(Monitor.CurrentValue);

        Service.CardAvatarHandler = GetAvatarUrl;
    }

    protected async Task<string> GetAvatarUrl(EventsPanelCardMonitor monitor)
    {
        return await Task.FromResult("https://www.sufficit.com.br/Relacionamento/Avatar.ashx");
    }
}